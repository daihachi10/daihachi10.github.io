<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>daihachi Schedule</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (JSX変換用) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Noto Sans JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            touch-action: manipulation; /* ダブルタップズーム防止 */
            -webkit-tap-highlight-color: transparent;
        }
        /* iOSのセーフエリア対応 */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* スクロールバー非表示 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Canvas描画用のフォント事前ロードハック */
        .font-preload { position: absolute; opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>
    <!-- フォントロード強制用 -->
    <div class="font-preload" style="font-weight: 100">あ</div>
    <div class="font-preload" style="font-weight: 400">あ</div>
    <div class="font-preload" style="font-weight: 700">あ</div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- アイコンコンポーネント (SVG直接定義) ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Share = (props) => <IconBase {...props}><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>;
        const Check = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const Sun = (props) => <IconBase {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>;
        const Cloud = (props) => <IconBase {...props}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M12 13.5v-6"/><path d="M12 13.5l-3-3"/><path d="M12 13.5l3-3"/></IconBase>; // Cloud Rain風にアレンジ
        const Moon = (props) => <IconBase {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;

        // --- メインアプリ ---
        function App() {
            const [currentDate, setCurrentDate] = useState(new Date(2026, 1, 1)); // 2026年2月
            const [selectedDates, setSelectedDates] = useState({});
            const [selectionMode, setSelectionMode] = useState('allDay');
            const [isSharing, setIsSharing] = useState(false);
            const canvasRef = useRef(null);

            // テーマカラー
            const THEME_GREEN = '#1db31d';

            // マーカー定義
            const markers = {
                allDay: { label: '終日', color: 'border-[#1db31d]', text: 'text-[#1db31d]', icon: Check, canvasColor: '#1db31d' },
                am: { label: '午前', color: 'border-orange-400', text: 'text-orange-400', icon: Sun, canvasColor: '#fb923c' },
                pm: { label: '午後', color: 'border-blue-400', text: 'text-blue-400', icon: Cloud, canvasColor: '#60a5fa' },
                night: { label: '夜間', color: 'border-indigo-500', text: 'text-indigo-500', icon: Moon, canvasColor: '#6366f1' },
                custom: { label: '解除', color: 'border-gray-200', text: 'text-gray-500', icon: Trash2, canvasColor: '#e5e7eb' },
            };

            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

            const handlePrevMonth = () => {
                setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            };

            const handleNextMonth = () => {
                setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            };

            const toggleDate = (day) => {
                const key = `${currentDate.getFullYear()}-${currentDate.getMonth()}-${day}`;
                
                if (selectionMode === 'custom') {
                    const newSelected = { ...selectedDates };
                    delete newSelected[key];
                    setSelectedDates(newSelected);
                    return;
                }

                if (selectedDates[key] === selectionMode) {
                    const newSelected = { ...selectedDates };
                    delete newSelected[key];
                    setSelectedDates(newSelected);
                } else {
                    setSelectedDates({ ...selectedDates, [key]: selectionMode });
                }
            };

            // Canvas描画ロジック
            const generateImageAndShare = async () => {
                setIsSharing(true);
                // フォントロード待ち（念のため）
                await document.fonts.ready;

                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                
                // 画像サイズ設定 (縦長比率)
                const width = 800;
                const height = 1300;
                canvas.width = width;
                canvas.height = height;

                // 1. 全体背景 (緑)
                ctx.fillStyle = THEME_GREEN;
                ctx.fillRect(0, 0, width, height);

                // 2. 上部テキスト "daihachi"
                ctx.fillStyle = '#ffffff';
                ctx.font = '50px "Noto Sans JP", sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('daihachi', width / 2, 80);

                // 3. 白いカード (カレンダー本体)
                const cardMargin = 40;
                const cardTop = 150;
                const cardHeight = height - 200; // 下の余白
                const cardWidth = width - (cardMargin * 2);
                const cornerRadius = 40;

                ctx.beginPath();
                // roundRectのポリフィル的な描画（古いブラウザ対応のため念のためパスで書くことも可能だが、最新環境ならroundRectでOK）
                if (ctx.roundRect) {
                    ctx.roundRect(cardMargin, cardTop, cardWidth, cardHeight, cornerRadius);
                } else {
                    ctx.rect(cardMargin, cardTop, cardWidth, cardHeight); // フォールバック
                }
                ctx.fillStyle = '#ffffff';
                ctx.fill();

                // 4. カレンダータイトル (年月)
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                ctx.fillStyle = '#333333';
                ctx.font = 'bold 50px "Noto Sans JP", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${year}年 ${month}月`, width / 2, cardTop + 80);

                // 5. 曜日ヘッダー
                const days = ['日', '月', '火', '水', '木', '金', '土'];
                const gridMargin = 50; 
                const effectiveCardWidth = cardWidth - (gridMargin * 2);
                const colWidth = effectiveCardWidth / 7;
                const headerY = cardTop + 160;
                
                ctx.font = 'bold 30px "Noto Sans JP", sans-serif';
                days.forEach((day, index) => {
                    ctx.fillStyle = index === 0 ? '#ef4444' : index === 6 ? '#3b82f6' : '#9ca3af';
                    const x = cardMargin + gridMargin + (colWidth * index) + (colWidth / 2);
                    ctx.fillText(day, x, headerY);
                });

                // 6. 日付グリッド (均等配置)
                const daysInMonth = getDaysInMonth(year, month - 1);
                const firstDay = getFirstDayOfMonth(year, month - 1);
                
                // 行数を計算
                const totalSlots = firstDay + daysInMonth;
                const weeks = Math.ceil(totalSlots / 7);

                // 行の高さを計算
                const gridStartY = headerY + 60;
                const gridBottomLimit = cardTop + cardHeight - 60;
                const availableHeight = gridBottomLimit - gridStartY;
                const rowHeight = availableHeight / weeks;

                let currentRow = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                    const colIndex = (firstDay + day - 1) % 7;
                    if (day > 1 && colIndex === 0) currentRow++;

                    const x = cardMargin + gridMargin + (colIndex * colWidth) + (colWidth / 2);
                    // 行の中央に配置
                    const y = gridStartY + (currentRow * rowHeight) + (rowHeight / 2) - 10; 
                    
                    const key = `${year}-${month - 1}-${day}`;
                    const mode = selectedDates[key];

                    // 選択マーク
                    if (mode) {
                        const color = markers[mode].canvasColor;
                        
                        ctx.beginPath();
                        const markY = y + 45; 
                        ctx.arc(x, markY, 14, 0, 2 * Math.PI);
                        ctx.lineWidth = 5;
                        ctx.strokeStyle = color;
                        ctx.stroke();

                        if (mode !== 'allDay') {
                            ctx.fillStyle = color;
                            ctx.font = 'bold 12px "Noto Sans JP", sans-serif';
                            ctx.fillText(markers[mode].label, x, markY + 25);
                        }
                    }

                    // 日付数字
                    ctx.fillStyle = colIndex === 0 ? '#ef4444' : colIndex === 6 ? '#3b82f6' : '#333333';
                    ctx.font = '300 42px "Noto Sans JP", sans-serif';
                    ctx.fillText(day, x, y);
                }

                // 7. 右下 URL
                ctx.fillStyle = '#ffffff';
                ctx.font = '20px "Noto Sans JP", sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText('daihachi.pages.dev', width - 40, height - 30);
                
                // シェア処理
                try {
                    canvas.toBlob(async (blob) => {
                        if (!blob) return;
                        const file = new File([blob], `schedule_${year}_${month}.png`, { type: 'image/png' });
                        
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share({ files: [file] });
                            } catch (err) {
                                console.log('Share canceled', err);
                            }
                        } else {
                            // PCや非対応ブラウザ向け: ダウンロード
                            const link = document.createElement('a');
                            link.download = `schedule_${year}_${month}.png`;
                            link.href = canvas.toDataURL();
                            link.click();
                            alert('画像を作成しました。保存して共有してください。');
                        }
                        setIsSharing(false);
                    });
                } catch (e) {
                    console.error(e);
                    setIsSharing(false);
                }
            };

            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = getDaysInMonth(year, month);
                const firstDay = getFirstDayOfMonth(year, month);
                
                const days = [];
                for (let i = 0; i < firstDay; i++) {
                    days.push(<div key={`empty-${i}`} className=""></div>);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const key = `${year}-${month}-${day}`;
                    const mode = selectedDates[key];
                    const isSelected = !!mode;
                    const isToday = new Date().getDate() === day && new Date().getMonth() === month && new Date().getFullYear() === year;

                    days.push(
                        <button
                            key={day}
                            onClick={() => toggleDate(day)}
                            className="flex flex-col items-center justify-start relative group w-full h-full py-2 tap-highlight-transparent"
                            style={{ WebkitTapHighlightColor: 'transparent' }}
                        >
                            {/* 日付数字 */}
                            <span className={`text-xl font-light ${
                                isToday ? 'text-[#1db31d] font-bold' : 
                                (day + firstDay - 1) % 7 === 0 ? 'text-red-500' :
                                (day + firstDay - 1) % 7 === 6 ? 'text-blue-500' : 'text-gray-700'
                            }`}>
                                {day}
                            </span>

                            {/* 下部のマーカーエリア */}
                            <div className="flex-1 flex flex-col justify-center items-center w-full mt-2">
                                {isSelected ? (
                                    <div className="flex flex-col items-center animate-in fade-in zoom-in duration-200">
                                        <div className={`w-5 h-5 rounded-full border-[3px] ${markers[mode].color} bg-transparent box-border mb-1`}></div>
                                        {mode !== 'allDay' && (
                                            <span className={`text-[9px] font-bold leading-none ${markers[mode].text.replace('text-white', 'text-gray-500')}`}>
                                                {markers[mode].label}
                                            </span>
                                        )}
                                    </div>
                                ) : (
                                    <div className="w-5 h-5 mb-1"></div>
                                )}
                            </div>
                        </button>
                    );
                }
                return days;
            };

            return (
                <div className="flex flex-col h-[100dvh] bg-gray-50 font-sans text-gray-900 select-none overflow-hidden">
                    {/* ヘッダー */}
                    <header className="bg-[#1db31d] text-white px-4 py-3 shadow-md shrink-0 safe-top z-30">
                        <div className="flex justify-between items-center max-w-md mx-auto">
                            <h1 className="text-lg font-bold tracking-wider">daihachi</h1>
                            <button
                                onClick={generateImageAndShare}
                                disabled={isSharing}
                                className="bg-white text-[#1db31d] px-4 py-1.5 rounded-full text-sm font-bold shadow-sm active:scale-95 transition-transform flex items-center"
                            >
                                {isSharing ? '作成中...' : (
                                    <React.Fragment>
                                        <Share className="w-4 h-4 mr-1.5" />
                                        共有
                                    </React.Fragment>
                                )}
                            </button>
                        </div>
                    </header>

                    {/* 月切り替えバー */}
                    <div className="bg-white p-2 shadow-sm shrink-0 z-20">
                        <div className="flex items-center justify-between max-w-md mx-auto">
                            <button onClick={handlePrevMonth} className="p-2 hover:bg-gray-100 rounded-full text-gray-600 active:bg-gray-200">
                                <ChevronLeft className="w-6 h-6" />
                            </button>
                            <span className="text-xl font-bold text-gray-800 tracking-widest">
                                {currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月
                            </span>
                            <button onClick={handleNextMonth} className="p-2 hover:bg-gray-100 rounded-full text-gray-600 active:bg-gray-200">
                                <ChevronRight className="w-6 h-6" />
                            </button>
                        </div>
                    </div>

                    {/* カレンダー本体 */}
                    <main className="flex-1 p-4 w-full max-w-md mx-auto flex flex-col min-h-0 z-10">
                        {/* 曜日ヘッダー */}
                        <div className="grid grid-cols-7 mb-2 text-center text-sm text-gray-400 shrink-0">
                            <div className="text-red-500">日</div>
                            <div>月</div>
                            <div>火</div>
                            <div>水</div>
                            <div>木</div>
                            <div>金</div>
                            <div className="text-blue-500">土</div>
                        </div>
                        
                        {/* 日付グリッド */}
                        <div className="flex-1 bg-white rounded-2xl p-2 shadow-sm grid grid-cols-7 grid-rows-6 gap-0">
                            {renderCalendar()}
                        </div>
                    </main>

                    {/* モード選択バー (固定フッター) */}
                    <div className="bg-white/95 backdrop-blur-sm border-t border-gray-100 p-4 pb-8 shrink-0 z-30 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] safe-bottom">
                        <div className="flex justify-between items-end max-w-md mx-auto px-2">
                            {Object.entries(markers).map(([key, config]) => {
                                const Icon = config.icon;
                                const isActive = selectionMode === key;
                                const isCustom = key === 'custom';
                                const bgClass = isActive 
                                    ? (isCustom ? 'bg-gray-200' : config.color.replace('border-', 'bg-')) 
                                    : 'bg-gray-100';
                                const textClass = isActive 
                                    ? (isCustom ? 'text-gray-600' : 'text-white') 
                                    : 'text-gray-400';

                                return (
                                    <button
                                        key={key}
                                        onClick={() => setSelectionMode(key)}
                                        className={`flex flex-col items-center space-y-1 transition-all duration-300 relative
                                            ${isActive ? 'transform -translate-y-2' : 'opacity-50 hover:opacity-80'}
                                        `}
                                    >
                                        <div className={`
                                            w-10 h-10 rounded-full flex items-center justify-center shadow-sm transition-colors duration-300
                                            ${bgClass} ${textClass}
                                            ${isActive ? 'ring-4 ring-white shadow-lg' : ''}
                                        `}>
                                            <Icon className="w-5 h-5" />
                                        </div>
                                        <span className={`text-[10px] font-bold ${isActive ? 'text-gray-800' : 'text-gray-400'}`}>
                                            {config.label}
                                        </span>
                                        
                                        {isActive && (
                                            <div className={`absolute -bottom-4 w-1 h-1 rounded-full ${isCustom ? 'bg-gray-400' : 'bg-[#1db31d]'}`}></div>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* 画像生成用Canvas (非表示) */}
                    <canvas ref={canvasRef} style={{ display: 'none' }} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

