<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>あきリスト | 空いている日を画像で共有</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <link rel="icon" href="https://daihachi.pages.dev/assets/favicon.ico" />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: 'Montserrat', 'Noto Sans JP', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        @keyframes zoomIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-zoom-in { animation: zoomIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-[100dvh] flex flex-col overflow-hidden select-none">

    <header class="bg-white px-4 py-3 shadow-sm shrink-0 safe-top z-30 border-b border-gray-100">
        <div class="flex justify-between items-center max-w-4xl mx-auto h-10">
            <a href="https://daihachi.pages.dev" class="flex items-center h-full hover:opacity-70 transition-opacity no-underline text-current mr-auto">
                <img src="https://daihachi10.github.io/assets/img/logo.webp" alt="D Logo" class="h-8 w-auto object-contain block shrink-0">
                <div class="flex items-center h-full pt-1 overflow-hidden"> 
                    <span class="mx-3 text-gray-300 text-2xl font-light transform -skew-x-12 leading-none">/</span>
                    <span class="text-[#1db31d] text-lg font-bold tracking-wide leading-none truncate">あきリスト</span>
                </div>
            </a>
            <div class="flex items-center gap-2">
                <button id="googleBtn" class="bg-white border border-gray-300 px-3 py-1.5 rounded-full text-xs font-bold flex items-center shadow-sm active:scale-95 transition-transform">
                    <img src="https://www.gstatic.com/images/branding/product/1x/calendar_2020q4_48dp.png" class="w-4 h-4 mr-1">
                    <span id="googleBtnText">予定読込</span>
                </button>
                <button id="shareBtn" class="bg-[#1db31d] text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-md active:scale-95 transition-transform">共有</button>
            </div>
        </div>
    </header>

    <div class="bg-white p-2 shadow-sm shrink-0 z-20 border-b border-gray-50">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <button id="prevMonth" class="p-2 text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            </button>
            <span id="currentMonthLabel" class="text-xl font-bold text-gray-800 tracking-widest"></span>
            <button id="nextMonth" class="p-2 text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
            </button>
        </div>
    </div>

    <main class="flex-1 p-4 w-full max-w-4xl mx-auto flex flex-col min-h-0 z-10 overflow-y-auto">
        <div class="grid grid-cols-7 mb-2 text-center text-sm text-gray-400 font-medium">
            <div class="text-red-500">日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div class="text-blue-500">土</div>
        </div>
        <div id="calendarGrid" class="flex-1 min-h-[350px] bg-white rounded-2xl p-2 shadow-sm grid grid-cols-7 gap-0 border border-gray-100"></div>
    </main>

    <!-- モード選択 -->
    <div class="bg-white/95 border-t border-gray-100 p-4 pb-8 shrink-0 z-30 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] safe-bottom">
        <div class="flex justify-around items-end max-w-2xl mx-auto px-2" id="modeSelector">
            <button class="mode-btn flex flex-col items-center space-y-1 transform -translate-y-2" data-mode="allDay">
                <div class="w-10 h-10 rounded-full flex items-center justify-center bg-[#1db31d] text-white ring-4 ring-white shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>
                <span class="label text-[10px] font-bold text-gray-800">終日</span>
                <div class="indicator w-1 h-1 rounded-full bg-[#1db31d]"></div>
            </button>
            <!-- 他のボタンは省略（既存コードを維持してください） -->
        </div>
    </div>

    <canvas id="shareCanvas" style="display: none;"></canvas>

    <script>
        // --- 設定 (Cloudflare WorkerのURLに書き換えてください) ---
        const WORKER_URL = 'https://aki-list-proxy.daihachi10sub.workers.dev/';
        const CLIENT_ID = 'http://1046190827691-paenml27s94v4egq8ofj96ic820bht90.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events.readonly';

        let currentDate = new Date();
        let selectedDates = {};
        let busyDates = {};
        let currentMode = 'allDay';
        let tokenClient;

        // --- Google API & Backend 連携 ---
        function init() {
            renderCalendar();
            setupEventListeners();
            
            const checkGSI = setInterval(() => {
                if (typeof google !== 'undefined') {
                    clearInterval(checkGSI);
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: async (resp) => {
                            if (resp.error) return;
                            await fetchEventsFromBackend(resp.access_token);
                        },
                    });
                }
            }, 100);
        }

        async function fetchEventsFromBackend(accessToken) {
            document.getElementById('googleBtnText').textContent = '読込中...';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const min = new Date(year, month, 1).toISOString();
            const max = new Date(year, month + 1, 1).toISOString();

            try {
                // Cloudflare Workerへリクエスト
                const response = await fetch(`${WORKER_URL}/events?timeMin=${min}&timeMax=${max}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                
                busyDates = {};
                data.items.forEach(event => {
                    const dateStr = event.start.split('T')[0];
                    const d = new Date(dateStr);
                    const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                    busyDates[key] = true;
                });

                document.getElementById('googleBtnText').textContent = '読込完了';
                renderCalendar();
            } catch (e) {
                console.error(e);
                document.getElementById('googleBtnText').textContent = 'エラー';
            }
        }

        // --- カレンダー描画ロジック (既存のものを維持) ---
        function renderCalendar(animatingDay = null) {
            const gridEl = document.getElementById('calendarGrid');
            const monthLabelEl = document.getElementById('currentMonthLabel');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthLabelEl.textContent = `${year}年 ${month + 1}月`;
            gridEl.innerHTML = '';

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const weeks = Math.ceil((firstDay + daysInMonth) / 7);
            gridEl.style.gridTemplateRows = `repeat(${weeks}, minmax(0, 1fr))`;

            for (let i = 0; i < firstDay; i++) gridEl.appendChild(document.createElement('div'));

            for (let day = 1; day <= daysInMonth; day++) {
                const key = `${year}-${month}-${day}`;
                const isBusy = busyDates[key];
                const mode = selectedDates[key];
                
                const btn = document.createElement('button');
                btn.className = "flex flex-col items-center justify-center relative w-full h-full";
                btn.onclick = () => {
                    if (selectedDates[key]) delete selectedDates[key];
                    else selectedDates[key] = currentMode;
                    renderCalendar(day);
                };

                btn.innerHTML = `
                    <div class="relative">
                        <span class="text-xl font-light">${day}</span>
                        ${isBusy ? `<div class="absolute -top-1 -right-2 w-1.5 h-1.5 bg-gray-300 rounded-full"></div>` : ''}
                    </div>
                    <div class="h-8 mt-1 flex justify-center items-center">
                        ${mode ? `<div class="w-5 h-5 rounded-full border-[3px] border-[#1db31d] ${day===animatingDay?'animate-zoom-in':''}"></div>` : ''}
                    </div>
                `;
                gridEl.appendChild(btn);
            }
        }

        function setupEventListeners() {
            document.getElementById('googleBtn').onclick = () => tokenClient.requestAccessToken({prompt: 'consent'});
            document.getElementById('prevMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
            document.getElementById('nextMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
            // shareBtn等のイベントは既存コードを維持
        }

        init();
    </script>
</body>
</html>

