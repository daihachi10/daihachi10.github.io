<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document</title>
</head>
<body>
<form id="contactForm">
    <div>
        <label>要件:</label>
        <select name="requirement" required>
            <option value="お見積もり">お見積もり</option>
            <option value="ご質問">ご質問</option>
            <option value="その他">その他</option>
        </select>
    </div>

    <div>
        <label>メールアドレス:</label>
        <input type="email" name="email" required>
    </div>

    <div>
        <label>希望日時:</label>
        <input type="datetime-local" name="datetime" required>
    </div>

    <div>
        <label>本文:</label>
        <textarea name="body" rows="4" required></textarea>
    </div>

    <button type="submit">送信</button>
</form>

<script>
    document.getElementById('contactForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            requirement: e.target.requirement.value,
            email: e.target.email.value,
            datetime: e.target.datetime.value,
            body: e.target.body.value
        };

        try {
            // fetch部分を修正
            const response = await fetch('https://script.google.com/macros/s/AKfycbxEzVerEPO0BHgPUl6l_fB4K5IDcQdknlyZlSynF6iL-HZlB0ZtyiIhuNtlYpAh3Ynr/exec', {
                method: 'POST',
                mode: 'cors', // 明示的にCORSモードを指定
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            });

            const result = await response.json();
            if (result.status === 'success') {
                alert('送信が成功しました');
                e.target.reset();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            alert(`エラーが発生しました: ${error.message}`);
        }
    });

        <h2>お問い合わせフォーム</h2>
    
    <div id="login-container">
        <div id="g_id_onload"
             data-client_id="304816629158-30vvphgdf08f16p5p5uqig9391jf7jlr.apps.googleusercontent.com"
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard"></div>
    </div>

    <div id="user-section" style="display: none;">
        <p>ログイン中: <span id="user-email"></span></p>
        
        <h3>新しいお問い合わせ</h3>
        <textarea id="message" placeholder="お問い合わせ内容を入力"></textarea><br>
        <button onclick="saveData()">送信</button>
        <h3>過去のお問い合わせ</h3>
        <button onclick="loadUserData()">更新</button>
        <div id="pastData"></div>
    </div>

    <script>
        let userEmail = "";
        function handleCredentialResponse(response) {
            fetch('https://script.google.com/macros/s/AKfycby3G_xdb9HeLPXS7grM1bW18iWdxIgU7m41AecN6tDmn2EYA0fmLEbxNV343pqBlyie/exec?mode=login', {
                method: 'POST',
                body: JSON.stringify({ id_token: response.credential }),
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    userEmail = data.email;
                    localStorage.setItem('user_email', userEmail);
                    document.getElementById('user-email').textContent = userEmail;
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('user-section').style.display = 'block';
                    loadUserData();
                } else {
                    alert('ログイン失敗');
                }
            });
        }

        function saveData() {
            if (!userEmail) {
                alert('ログインしてください');
                return;
            }

            const content = document.getElementById('message').value;
            if (!content) {
                alert('内容を入力してください');
                return;
            }

            fetch('GASのウェブアプリURL?mode=save', {
                method: 'POST',
                body: JSON.stringify({ email: userEmail, content }),
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('送信成功');
                    document.getElementById('message').value = '';
                    loadUserData();
                } else {
                    alert('送信失敗');
                }
            });
        }

        function loadUserData() {
            if (!userEmail) return;

            fetch('GASのウェブアプリURL?mode=fetch', {
                method: 'POST',
                body: JSON.stringify({ email: userEmail }),
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                const pastDataDiv = document.getElementById('pastData');
                pastDataDiv.innerHTML = data.map(entry => `<p>${new Date(entry.date).toLocaleString()}: ${entry.content}</p>`).join('');
            });
        }

        // ページ読み込み時にログイン状態を確認
        window.onload = () => {
            userEmail = localStorage.getItem('user_email');
            if (userEmail) {
                document.getElementById('user-email').textContent = userEmail;
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('user-section').style.display = 'block';
                loadUserData();
            }
        };
    </script>

</script>
</body>
</html>
