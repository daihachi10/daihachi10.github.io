<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyLens Lite (Single File)</title>
    
    <!-- Tailwind CSS (デザイン用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UI構築用) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (ブラウザ内でJSXを変換用) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js (グラフ描画用) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* スクロールバーの調整など */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- アプリケーションのコード -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. アイコンコンポーネント (Lucide互換SVG) ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );
        const Icons = {
            Play: (p) => <Icon {...p} path={<polygon points="5 3 19 12 5 21 5 3"></polygon>} />,
            Pause: (p) => <Icon {...p} path={<><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></>} />,
            Smartphone: (p) => <Icon {...p} path={<><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></>} />,
            Coffee: (p) => <Icon {...p} path={<><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></>} />,
            Bed: (p) => <Icon {...p} path={<><path d="M2 4v16"></path><path d="M2 8h18a2 2 0 0 1 2 2v10"></path><path d="M2 17h20"></path><path d="M6 8v9"></path></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></>} />,
            Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>} />,
            BarChart2: (p) => <Icon {...p} path={<><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></>} />,
            BrainCircuit: (p) => <Icon {...p} path={<><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"></path><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"></path><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"></path><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"></path><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"></path><path d="M3.477 10.896a4 4 0 0 1 .585-.396"></path><path d="M19.938 10.5a4 4 0 0 1 .585.396"></path><path d="M6 18a4 4 0 0 1-1.97-3.284"></path><path d="M17.97 14.716A4 4 0 0 1 16 18"></path></>} />,
            Settings: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></>} />
        };

        // --- 2. ユーティリティ関数 & Hooks ---
        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.error(error);
                }
            };
            return [storedValue, setValue];
        }

        // ICSファイル生成ロジック
        function generateICS(events) {
            const formatDate = (arr) => {
                // arr = [YYYY, MM, DD, HH, mm] -> "YYYYMMDDTHHmm00"
                const pad = (n) => n.toString().padStart(2, '0');
                return `${arr[0]}${pad(arr[1])}${pad(arr[2])}T${pad(arr[3])}${pad(arr[4])}00`;
            };

            const now = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            let content = "BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//StudyLens//Lite//EN\r\n";
            
            events.forEach(ev => {
                const startTime = formatDate(ev.start);
                const startObj = new Date(ev.start[0], ev.start[1]-1, ev.start[2], ev.start[3], ev.start[4]);
                const endObj = new Date(startObj.getTime() + ev.duration.minutes * 60000);
                const formatEnd = (d) => 
                    d.getFullYear() + 
                    (d.getMonth()+1).toString().padStart(2,'0') + 
                    d.getDate().toString().padStart(2,'0') + "T" + 
                    d.getHours().toString().padStart(2,'0') + 
                    d.getMinutes().toString().padStart(2,'0') + "00";
                
                content += "BEGIN:VEVENT\r\n";
                content += `UID:${Date.now()}_${Math.random().toString(36).substr(2,9)}\r\n`;
                content += `DTSTAMP:${now}\r\n`;
                content += `DTSTART:${startTime}\r\n`;
                content += `DTEND:${formatEnd(endObj)}\r\n`;
                content += `SUMMARY:${ev.title}\r\n`;
                content += "END:VEVENT\r\n";
            });
            content += "END:VCALENDAR";
            return content;
        }

        // --- 3. コンポーネント実装 ---

        function Timer({ onSaveLog }) {
            const [seconds, setSeconds] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [interruptions, setInterruptions] = useState([]);

            useEffect(() => {
                let interval = null;
                if (isRunning) {
                    interval = setInterval(() => setSeconds(s => s + 1), 1000);
                }
                return () => clearInterval(interval);
            }, [isRunning]);

            const toggleTimer = () => {
                if (isRunning) {
                    setIsRunning(false);
                    setShowModal(true);
                } else {
                    setIsRunning(true);
                }
            };

            const addInterruption = (reason) => {
                setInterruptions([...interruptions, { reason, time: new Date().toISOString() }]);
                setShowModal(false);
            };

            const finishStudy = () => {
                const log = {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    durationSec: seconds,
                    interruptionCount: interruptions.length,
                    interruptions: interruptions,
                    createdAt: new Date().toISOString()
                };
                onSaveLog(log);
                setSeconds(0);
                setInterruptions([]);
                setIsRunning(false);
            };

            const formatTime = (sec) => {
                const h = Math.floor(sec / 3600).toString().padStart(2, '0');
                const m = Math.floor((sec % 3600) / 60).toString().padStart(2, '0');
                const s = (sec % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg text-center max-w-md mx-auto">
                    <h2 className="text-2xl font-bold mb-4 text-gray-700">学習タイマー</h2>
                    <div className="text-6xl font-mono mb-8 text-blue-600 tracking-wider">{formatTime(seconds)}</div>
                    
                    <div className="flex justify-center gap-4">
                        <button onClick={toggleTimer} className={`px-8 py-4 rounded-full text-xl font-bold flex items-center gap-2 text-white transition shadow-md ${isRunning ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'}`}>
                            {isRunning ? <><Icons.Pause className="w-6 h-6"/> 一時停止</> : <><Icons.Play className="w-6 h-6"/> スタート</>}
                        </button>
                        
                        {!isRunning && seconds > 0 && (
                            <button onClick={finishStudy} className="px-8 py-4 bg-blue-600 text-white rounded-full text-xl font-bold flex items-center gap-2 hover:bg-blue-700 shadow-md">
                                <Icons.Save className="w-6 h-6"/> 終了
                            </button>
                        )}
                    </div>

                    {showModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-xl max-w-sm w-full shadow-2xl animate-fade-in">
                                <h3 className="text-xl font-bold mb-4 text-center">中断理由は？</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    {[
                                        { l: 'スマホ', i: Icons.Smartphone, c: 'bg-red-100 text-red-600' },
                                        { l: '休憩', i: Icons.Coffee, c: 'bg-green-100 text-green-600' },
                                        { l: '眠気', i: Icons.Bed, c: 'bg-purple-100 text-purple-600' },
                                        { l: '会話', i: Icons.Users, c: 'bg-orange-100 text-orange-600' }
                                    ].map(b => (
                                        <button key={b.l} onClick={() => addInterruption(b.l)} className={`${b.c} p-4 rounded-lg flex flex-col items-center hover:opacity-80 transition`}>
                                            <b.i className="w-8 h-8 mb-2"/>{b.l}
                                        </button>
                                    ))}
                                </div>
                                <button onClick={() => setShowModal(false)} className="mt-6 w-full py-2 text-gray-500 hover:text-gray-700 border rounded">キャンセル</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function Analytics({ logs }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            const reasonCounts = {};
            logs.forEach(log => {
                log.interruptions.forEach(int => {
                    reasonCounts[int.reason] = (reasonCounts[int.reason] || 0) + 1;
                });
            });

            useEffect(() => {
                if (!chartRef.current) return;
                
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const ctx = chartRef.current.getContext('2d');
                const dataValues = Object.values(reasonCounts);
                const labels = Object.keys(reasonCounts);
                
                if (dataValues.length === 0) return;

                chartInstance.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: dataValues,
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) chartInstance.current.destroy();
                };
            }, [logs]);

            const totalStudy = Math.round(logs.reduce((acc, log) => acc + log.durationSec, 0) / 60);
            const totalInt = logs.reduce((acc, log) => acc + log.interruptionCount, 0);

            let advice = "データが不足しています。勉強を記録しましょう！";
            if (logs.length > 0) {
                if (totalInt / logs.length > 2) advice = "中断が多いようです。スマホを遠ざけてみましょう。";
                else if (totalStudy > 120) advice = "素晴らしい集中力です！この調子で。";
                else advice = "コツコツ積み重ねが大事です。";
            }

            return (
                <div className="grid md:grid-cols-2 gap-6">
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h3 className="text-xl font-bold mb-4">中断要因の内訳</h3>
                        {Object.keys(reasonCounts).length > 0 ? (
                            <div className="w-64 mx-auto"><canvas ref={chartRef}></canvas></div>
                        ) : (
                            <div className="text-center py-12 text-gray-400">データがありません</div>
                        )}
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h3 className="text-xl font-bold mb-2">AI分析 (疑似)</h3>
                        <div className="p-4 bg-blue-50 border-l-4 border-blue-500 text-blue-800 mb-4 rounded-r">
                            <span className="font-bold">Advice:</span> {advice}
                        </div>
                        <div className="space-y-2">
                            <div className="flex justify-between border-b pb-2"><span>総学習時間</span><span className="font-bold text-xl">{totalStudy} 分</span></div>
                            <div className="flex justify-between border-b pb-2"><span>総中断回数</span><span className="font-bold text-xl text-red-500">{totalInt} 回</span></div>
                            <div className="flex justify-between"><span>記録回数</span><span className="font-bold">{logs.length} 回</span></div>
                        </div>
                    </div>
                </div>
            );
        }

        function AIPlanner({ apiKey }) {
            const [prompt, setPrompt] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);

            const generatePlan = async () => {
                if (!apiKey) return alert('設定画面でAPIキーを入力してください');
                setLoading(true);
                
                const today = new Date();
                const dateInfo = `今日は${today.getFullYear()}年${today.getMonth()+1}月${today.getDate()}日です。`;

                const systemPrompt = `
                    ${dateInfo}
                    あなたは学習コーチです。ユーザーの要望に基づき、学習スケジュールを提案してください。
                    必ず以下のJSON配列形式のみを返してください。マークダウン(code block)は不要です。
                    フォーマット例:
                    [
                        {"title": "数学", "start": [2025, 5, 21, 18, 0], "duration": {"minutes": 45}},
                        {"title": "英語", "start": [2025, 5, 21, 19, 0], "duration": {"minutes": 30}}
                    ]
                `;

                // 修正箇所: モデル名を厳密に指定 (gemini-1.5-flash-001)
                const modelName = "gemini-1.5-flash-001"; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

                try {
                    const res = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: systemPrompt + "\nユーザー要望: " + prompt }] }]
                        })
                    });
                    
                    const data = await res.json();
                    
                    // エラーハンドリング
                    if(data.error) {
                        console.error("Gemini API Error:", data.error);
                        throw new Error(data.error.message);
                    }
                    
                    const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                    setResult(JSON.parse(text));
                } catch (e) {
                    alert('エラーが発生しました:\n' + e.message + '\n\n※APIキーが「Google AI Studio」で作成されたものか確認してください。');
                } finally {
                    setLoading(false);
                }
            };

            const downloadFile = () => {
                if (!result) return;
                const icsText = generateICS(result);
                const blob = new Blob([icsText], { type: "text/calendar;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'plan.ics';
                a.click();
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg">
                    <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
                        <Icons.BrainCircuit className="text-purple-600"/> AI学習プランナー
                    </h2>
                    <textarea 
                        className="w-full p-4 border rounded-lg mb-4 bg-gray-50 focus:ring-2 ring-purple-200 outline-none" 
                        rows="4" 
                        placeholder="例: 今週末に歴史のテストがあります。土曜日の午前中に集中して覚えるスケジュールを立てて。"
                        value={prompt}
                        onChange={e => setPrompt(e.target.value)}
                    ></textarea>
                    <button onClick={generatePlan} disabled={loading} className="bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-700 w-full transition disabled:bg-gray-400">
                        {loading ? 'AIが思考中...' : '計画を作成 (Gemini)'}
                    </button>

                    {result && (
                        <div className="mt-6 p-4 bg-green-50 rounded-lg border border-green-200 animate-fade-in">
                            <h3 className="font-bold mb-3 text-green-800 border-b border-green-200 pb-2">提案スケジュール:</h3>
                            <ul className="space-y-2 mb-4 text-sm text-green-900">
                                {result.map((ev, i) => (
                                    <li key={i} className="flex gap-2">
                                        <span className="font-mono bg-white px-1 rounded border">{ev.start[1]}/{ev.start[2]} {ev.start[3]}:{ev.start[4].toString().padStart(2,'0')}</span>
                                        <span className="font-bold">{ev.title}</span>
                                        <span className="text-gray-500">({ev.duration.minutes}分)</span>
                                    </li>
                                ))}
                            </ul>
                            <button onClick={downloadFile} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 w-full shadow text-sm">
                                カレンダーに追加 (.ics)
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // --- 4. Main App ---
        function App() {
            const [activeTab, setActiveTab] = useState('timer');
            const [logs, setLogs] = useLocalStorage('studyLensLogs', []);
            const [apiKey, setApiKey] = useLocalStorage('geminiApiKey', '');

            const handleExport = () => {
                const blob = new Blob([JSON.stringify(logs)], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = "studylens_backup.json";
                a.click();
            };

            return (
                <div className="min-h-screen pb-24">
                    <header className="bg-white shadow-sm p-4 sticky top-0 z-10">
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            <h1 className="text-xl font-black text-blue-600 tracking-tight flex items-center gap-2">
                                StudyLens<span className="text-gray-400 font-light text-sm">Lite</span>
                            </h1>
                            <button onClick={() => setActiveTab('settings')} className="text-gray-400 hover:text-blue-600 transition">
                                <Icons.Settings className="w-6 h-6"/>
                            </button>
                        </div>
                    </header>

                    <main className="max-w-3xl mx-auto p-4 mt-2">
                        {activeTab === 'timer' && <Timer onSaveLog={l => setLogs([...logs, l])} />}
                        {activeTab === 'analytics' && <Analytics logs={logs} />}
                        {activeTab === 'ai' && <AIPlanner apiKey={apiKey} />}
                        
                        {activeTab === 'settings' && (
                            <div className="bg-white p-6 rounded-xl shadow-lg">
                                <h2 className="text-2xl font-bold mb-6">設定</h2>
                                <div className="mb-6">
                                    <label className="block font-bold mb-2 text-sm text-gray-600">Gemini API Key</label>
                                    <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full p-3 border rounded-lg bg-gray-50 font-mono text-sm" placeholder="sk-..." />
                                    <p className="text-xs text-gray-400 mt-2">※キーはあなたのブラウザ内にのみ保存されます。サーバーには送信されません。</p>
                                    <p className="text-xs text-blue-500 mt-1"><a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studioでキーを取得</a></p>
                                </div>
                                <div className="border-t pt-6">
                                    <button onClick={handleExport} className="bg-gray-100 text-gray-700 px-4 py-2 rounded hover:bg-gray-200 text-sm font-bold border">データバックアップ (JSON)</button>
                                    <button onClick={() => confirm('本当に削除しますか？') && setLogs([])} className="ml-4 text-red-500 text-sm hover:underline">データ全削除</button>
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-3 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
                        {[
                            { id: 'timer', icon: Icons.Clock, label: '計測' },
                            { id: 'analytics', icon: Icons.BarChart2, label: '分析' },
                            { id: 'ai', icon: Icons.BrainCircuit, label: 'AI計画' }
                        ].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center gap-1 w-full ${activeTab === tab.id ? 'text-blue-600' : 'text-gray-400 hover:text-gray-500'}`}>
                                <tab.icon className="w-6 h-6"/>
                                <span className="text-[10px] font-bold">{tab.label}</span>
                            </button>
                        ))}
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>