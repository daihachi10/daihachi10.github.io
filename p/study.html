<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyLens Lite - å­¦ç¿’è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .timer-display { font-family: 'Courier New', monospace; }
        .reason-btn { transition: all 0.2s; }
        .reason-btn:hover { transform: scale(1.1); }
        .reason-btn.selected { ring: 4px; ring-color: #667eea; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen">
    <div id="app" class="max-w-lg mx-auto p-4">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="text-center mb-6">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                ğŸ“š StudyLens Lite
            </h1>
            <p class="text-gray-500 text-sm">å­¦ç¿’ã‚’è¦‹ãˆã‚‹åŒ–ã—ã‚ˆã†</p>
        </header>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="flex gap-1 mb-6 bg-white rounded-xl p-1 shadow-lg">
            <button onclick="switchTab('timer')" id="tab-timer" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium tab-active">
                â±ï¸ ã‚¿ã‚¤ãƒãƒ¼
            </button>
            <button onclick="switchTab('stats')" id="tab-stats" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">
                ğŸ“Š åˆ†æ
            </button>
            <button onclick="switchTab('ai')" id="tab-ai" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">
                ğŸ¤– AI
            </button>
            <button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">
                âš™ï¸
            </button>
        </nav>

        <!-- ã‚¿ã‚¤ãƒãƒ¼ã‚¿ãƒ– -->
        <div id="panel-timer" class="tab-panel fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
                <div class="text-center">
                    <div id="timer-display" class="timer-display text-6xl font-bold text-gray-800 mb-4">
                        00:00:00
                    </div>
                    <div id="timer-status" class="text-sm text-gray-500 mb-4">
                        æº–å‚™å®Œäº†
                    </div>
                    
                    <!-- ç¾åœ¨ã®ä¸­æ–­ç‡ -->
                    <div id="current-rate" class="bg-gray-50 rounded-lg p-3 mb-4 hidden">
                        <span class="text-sm text-gray-600">ç¾åœ¨ã®ä¸­æ–­ç‡: </span>
                        <span id="interrupt-rate" class="font-bold text-orange-500">0%</span>
                    </div>

                    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
                    <div class="flex gap-3 justify-center">
                        <button id="btn-start" onclick="startTimer()" class="bg-gradient-to-r from-green-400 to-green-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:shadow-xl transition-all">
                            â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ
                        </button>
                        <button id="btn-pause" onclick="pauseTimer()" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:shadow-xl transition-all hidden">
                            â¸ï¸ ä¸­æ–­
                        </button>
                        <button id="btn-resume" onclick="resumeTimer()" class="bg-gradient-to-r from-blue-400 to-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:shadow-xl transition-all hidden">
                            â–¶ï¸ å†é–‹
                        </button>
                        <button id="btn-stop" onclick="stopTimer()" class="bg-gradient-to-r from-red-400 to-red-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:shadow-xl transition-all hidden">
                            â¹ï¸ çµ‚äº†
                        </button>
                    </div>
                </div>
            </div>

            <!-- ä»Šæ—¥ã®è¨˜éŒ²ã‚µãƒãƒªãƒ¼ -->
            <div class="bg-white rounded-2xl shadow-xl p-4">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ“… ä»Šæ—¥ã®è¨˜éŒ²</h3>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-green-50 rounded-lg p-3">
                        <div id="today-study" class="text-2xl font-bold text-green-600">0</div>
                        <div class="text-xs text-gray-500">å‹‰å¼·(åˆ†)</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-3">
                        <div id="today-interrupt" class="text-2xl font-bold text-orange-600">0</div>
                        <div class="text-xs text-gray-500">ä¸­æ–­(åˆ†)</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-3">
                        <div id="today-sessions" class="text-2xl font-bold text-purple-600">0</div>
                        <div class="text-xs text-gray-500">ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸­æ–­ç†ç”±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="interrupt-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-6 m-4 max-w-sm w-full fade-in">
                <h3 class="text-xl font-bold text-center mb-4">ä½•ã—ã¦ãŸï¼ŸğŸ¤”</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="selectReason('smartphone')" class="reason-btn bg-blue-50 hover:bg-blue-100 p-4 rounded-xl text-center" data-reason="smartphone">
                        <div class="text-3xl mb-1">ğŸ“±</div>
                        <div class="text-sm">ã‚¹ãƒãƒ›</div>
                    </button>
                    <button onclick="selectReason('family')" class="reason-btn bg-pink-50 hover:bg-pink-100 p-4 rounded-xl text-center" data-reason="family">
                        <div class="text-3xl mb-1">ğŸ </div>
                        <div class="text-sm">å®¶æ—</div>
                    </button>
                    <button onclick="selectReason('sleepy')" class="reason-btn bg-purple-50 hover:bg-purple-100 p-4 rounded-xl text-center" data-reason="sleepy">
                        <div class="text-3xl mb-1">ğŸ’¤</div>
                        <div class="text-sm">çœ æ°—</div>
                    </button>
                    <button onclick="selectReason('toilet')" class="reason-btn bg-green-50 hover:bg-green-100 p-4 rounded-xl text-center" data-reason="toilet">
                        <div class="text-3xl mb-1">ğŸš½</div>
                        <div class="text-sm">ãƒˆã‚¤ãƒ¬</div>
                    </button>
                    <button onclick="selectReason('snack')" class="reason-btn bg-yellow-50 hover:bg-yellow-100 p-4 rounded-xl text-center" data-reason="snack">
                        <div class="text-3xl mb-1">ğŸª</div>
                        <div class="text-sm">ãŠã‚„ã¤</div>
                    </button>
                    <button onclick="selectReason('other')" class="reason-btn bg-gray-50 hover:bg-gray-100 p-4 rounded-xl text-center" data-reason="other">
                        <div class="text-3xl mb-1">â“</div>
                        <div class="text-sm">ãã®ä»–</div>
                    </button>
                </div>
                <p class="text-center text-gray-400 text-sm">ç†ç”±ã‚’é¸ã‚“ã§ã­</p>
            </div>
        </div>

        <!-- çµ‚äº†ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="finish-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-6 m-4 max-w-sm w-full fade-in">
                <h3 class="text-xl font-bold text-center mb-4">ãŠç–²ã‚Œã•ã¾ï¼ğŸ‰</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä»Šå›ã®é›†ä¸­åº¦ã¯ï¼Ÿ</label>
                    <div class="flex justify-center gap-2">
                        <button onclick="setConcentration(1)" class="conc-btn w-10 h-10 rounded-full bg-red-100 hover:bg-red-200 text-red-600 font-bold">1</button>
                        <button onclick="setConcentration(2)" class="conc-btn w-10 h-10 rounded-full bg-orange-100 hover:bg-orange-200 text-orange-600 font-bold">2</button>
                        <button onclick="setConcentration(3)" class="conc-btn w-10 h-10 rounded-full bg-yellow-100 hover:bg-yellow-200 text-yellow-600 font-bold">3</button>
                        <button onclick="setConcentration(4)" class="conc-btn w-10 h-10 rounded-full bg-green-100 hover:bg-green-200 text-green-600 font-bold">4</button>
                        <button onclick="setConcentration(5)" class="conc-btn w-10 h-10 rounded-full bg-emerald-100 hover:bg-emerald-200 text-emerald-600 font-bold">5</button>
                    </div>
                </div>
                <div id="session-summary" class="bg-gray-50 rounded-lg p-3 mb-4 text-sm">
                    <!-- å‹•çš„ã«è¡¨ç¤º -->
                </div>
                <button onclick="saveSession()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl font-bold">
                    ä¿å­˜ã™ã‚‹
                </button>
            </div>
        </div>

        <!-- åˆ†æã‚¿ãƒ– -->
        <div id="panel-stats" class="tab-panel hidden">
            <div class="bg-white rounded-2xl shadow-xl p-4 mb-4 fade-in">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ“ˆ å‹‰å¼· vs ä¸­æ–­</h3>
                <div class="h-48">
                    <canvas id="chart-doughnut"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-4 mb-4 fade-in">
                <h3 class="font-bold text-gray-700 mb-3">â° æ™‚é–“å¸¯åˆ¥ã®é›†ä¸­åº¦</h3>
                <div class="h-48">
                    <canvas id="chart-hourly"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-4 mb-4 fade-in">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ” ä¸­æ–­ç†ç”±ã®å†…è¨³</h3>
                <div class="h-48">
                    <canvas id="chart-reasons"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-4 fade-in">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ’¡ è‡ªå‹•ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
                <div id="auto-advice" class="space-y-2 text-sm">
                    <p class="text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã‚‹ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
        </div>

        <!-- AIãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã‚¿ãƒ– -->
        <div id="panel-ai" class="tab-panel hidden">
            <div class="bg-white rounded-2xl shadow-xl p-4 mb-4 fade-in">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ¤– AIå­¦ç¿’ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h3>
                <div id="ai-status" class="text-sm mb-3">
                    <span class="text-gray-500">APIã‚­ãƒ¼: </span>
                    <span id="api-status" class="text-red-500">æœªè¨­å®š</span>
                </div>
                <textarea id="ai-input" class="w-full border rounded-xl p-3 text-sm h-32 resize-none" placeholder="ä¾‹: æ¥é€±ã®æœˆæ›œã«æ•°å­¦ã®ãƒ†ã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ç¯„å›²ã¯äºŒæ¬¡æ–¹ç¨‹å¼ã¨å› æ•°åˆ†è§£ã§ã™ã€‚ã©ã†å‹‰å¼·ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ"></textarea>
                <button onclick="askAI()" id="btn-ask-ai" class="w-full mt-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl font-bold">
                    ğŸª„ è¨ˆç”»ã‚’ä½œæˆ
                </button>
            </div>

            <div id="ai-result" class="bg-white rounded-2xl shadow-xl p-4 mb-4 hidden fade-in">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ“‹ AIã‹ã‚‰ã®ææ¡ˆ</h3>
                <div id="ai-response" class="text-sm text-gray-700 whitespace-pre-wrap"></div>
                <button onclick="downloadICS()" class="w-full mt-4 bg-gradient-to-r from-green-400 to-green-600 text-white py-2 rounded-xl font-bold">
                    ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ (.ics)
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-4 fade-in">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ“Š ã‚ãªãŸã®å­¦ç¿’å‚¾å‘ï¼ˆAIç”¨ãƒ‡ãƒ¼ã‚¿ï¼‰</h3>
                <div id="ai-data-preview" class="text-xs text-gray-500 bg-gray-50 rounded-lg p-3 max-h-40 overflow-auto">
                    ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                </div>
            </div>
        </div>

        <!-- è¨­å®šã‚¿ãƒ– -->
        <div id="panel-settings" class="tab-panel hidden">
            <div class="bg-white rounded-2xl shadow-xl p-4 mb-4 fade-in">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ”‘ Gemini APIã‚­ãƒ¼è¨­å®š</h3>
                <p class="text-xs text-gray-500 mb-3">
                    AIæ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯<a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-600 underline">Google AI Studio</a>ã§APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ãã ã•ã„ï¼ˆç„¡æ–™ï¼‰
                </p>
                <input type="password" id="api-key-input" class="w-full border rounded-xl p-3 text-sm mb-3" placeholder="AIzaSy...">
                <button onclick="saveApiKey()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-2 rounded-xl font-bold">
                    ä¿å­˜
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-4 mb-4 fade-in">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                <div class="space-y-3">
                    <button onclick="exportData()" class="w-full bg-blue-500 text-white py-2 rounded-xl font-bold">
                        ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
                    </button>
                    <div>
                        <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
                        <button onclick="document.getElementById('import-file').click()" class="w-full bg-green-500 text-white py-2 rounded-xl font-bold">
                            ğŸ“¤ å¾©å…ƒï¼ˆJSONã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
                        </button>
                    </div>
                    <button onclick="clearAllData()" class="w-full bg-red-500 text-white py-2 rounded-xl font-bold">
                        ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-4 fade-in">
                <h3 class="font-bold text-gray-700 mb-3">ğŸ“œ å±¥æ­´</h3>
                <div id="history-list" class="space-y-2 max-h-64 overflow-auto text-sm">
                    <p class="text-gray-500">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== ãƒ‡ãƒ¼ã‚¿ç®¡ç† =====
        const STORAGE_KEY = 'studyLensData';
        
        function getDefaultData() {
            return {
                settings: { geminiApiKey: '', userName: '' },
                logs: []
            };
        }

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : getDefaultData();
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // ===== ã‚¿ã‚¤ãƒãƒ¼ç®¡ç† =====
        let timerState = {
            isRunning: false,
            isPaused: false,
            startTime: null,
            pauseStartTime: null,
            totalPauseTime: 0,
            elapsedSeconds: 0,
            intervalId: null,
            currentInterruptions: [],
            selectedConcentration: 3
        };

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            document.getElementById('timer-display').textContent = formatTime(timerState.elapsedSeconds);
            
            // ä¸­æ–­ç‡ã®æ›´æ–°
            if (timerState.isRunning || timerState.isPaused) {
                const totalSec = timerState.elapsedSeconds + (timerState.totalPauseTime / 1000);
                const pauseSec = timerState.totalPauseTime / 1000;
                const rate = totalSec > 0 ? Math.round((pauseSec / totalSec) * 100) : 0;
                document.getElementById('interrupt-rate').textContent = rate + '%';
                document.getElementById('current-rate').classList.remove('hidden');
            }
        }

        function startTimer() {
            timerState = {
                isRunning: true,
                isPaused: false,
                startTime: Date.now(),
                pauseStartTime: null,
                totalPauseTime: 0,
                elapsedSeconds: 0,
                intervalId: null,
                currentInterruptions: [],
                selectedConcentration: 3
            };

            timerState.intervalId = setInterval(() => {
                if (!timerState.isPaused) {
                    const elapsed = Date.now() - timerState.startTime - timerState.totalPauseTime;
                    timerState.elapsedSeconds = Math.floor(elapsed / 1000);
                    updateTimerDisplay();
                }
            }, 1000);

            document.getElementById('timer-status').textContent = 'ğŸ”¥ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰';
            document.getElementById('timer-status').classList.add('text-green-600');
            document.getElementById('btn-start').classList.add('hidden');
            document.getElementById('btn-pause').classList.remove('hidden');
            document.getElementById('btn-stop').classList.remove('hidden');
            document.getElementById('current-rate').classList.remove('hidden');
        }

        function pauseTimer() {
            timerState.isPaused = true;
            timerState.pauseStartTime = Date.now();
            
            document.getElementById('timer-status').textContent = 'â¸ï¸ ä¸­æ–­ä¸­...';
            document.getElementById('timer-status').classList.remove('text-green-600');
            document.getElementById('timer-status').classList.add('text-orange-500');
            document.getElementById('btn-pause').classList.add('hidden');
            document.getElementById('btn-resume').classList.remove('hidden');
            
            // ä¸­æ–­ç†ç”±ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            document.getElementById('interrupt-modal').classList.remove('hidden');
        }

        function selectReason(reason) {
            // æ—¢å­˜ã®ç†ç”±ã‚’æ¢ã™
            const existing = timerState.currentInterruptions.find(i => i.reason === reason);
            if (existing) {
                existing.count++;
            } else {
                timerState.currentInterruptions.push({ reason, count: 1 });
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.getElementById('interrupt-modal').classList.add('hidden');
        }

        function resumeTimer() {
            const pauseDuration = Date.now() - timerState.pauseStartTime;
            timerState.totalPauseTime += pauseDuration;
            timerState.isPaused = false;
            timerState.pauseStartTime = null;

            document.getElementById('timer-status').textContent = 'ğŸ”¥ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰';
            document.getElementById('timer-status').classList.remove('text-orange-500');
            document.getElementById('timer-status').classList.add('text-green-600');
            document.getElementById('btn-resume').classList.add('hidden');
            document.getElementById('btn-pause').classList.remove('hidden');
        }

        function stopTimer() {
            clearInterval(timerState.intervalId);
            
            // ä¸­æ–­ä¸­ãªã‚‰ä¸­æ–­æ™‚é–“ã‚’åŠ ç®—
            if (timerState.isPaused && timerState.pauseStartTime) {
                timerState.totalPauseTime += Date.now() - timerState.pauseStartTime;
            }
            
            timerState.isRunning = false;
            
            // çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            const totalMin = Math.round(timerState.elapsedSeconds / 60);
            const interruptMin = Math.round(timerState.totalPauseTime / 60000);
            const studyMin = totalMin;
            
            document.getElementById('session-summary').innerHTML = `
                <div class="flex justify-between"><span>ç·æ™‚é–“:</span><span class="font-bold">${totalMin}åˆ†</span></div>
                <div class="flex justify-between"><span>ä¸­æ–­æ™‚é–“:</span><span class="font-bold text-orange-500">${interruptMin}åˆ†</span></div>
                <div class="flex justify-between"><span>å®Ÿè³ªå‹‰å¼·:</span><span class="font-bold text-green-600">${studyMin - interruptMin}åˆ†</span></div>
            `;
            document.getElementById('finish-modal').classList.remove('hidden');
        }

        function setConcentration(level) {
            timerState.selectedConcentration = level;
            document.querySelectorAll('.conc-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-indigo-400');
            });
            event.target.classList.add('ring-4', 'ring-indigo-400');
        }

        function saveSession() {
            const data = loadData();
            const now = new Date();
            const startDate = new Date(timerState.startTime);
            
            const log = {
                id: Date.now(),
                date: now.toISOString().split('T')[0],
                startTime: startDate.toTimeString().slice(0, 5),
                endTime: now.toTimeString().slice(0, 5),
                totalDurationMin: Math.round(timerState.elapsedSeconds / 60),
                actualStudyMin: Math.round((timerState.elapsedSeconds - timerState.totalPauseTime / 1000) / 60),
                interruptionMin: Math.round(timerState.totalPauseTime / 60000),
                concentration: timerState.selectedConcentration,
                isSchoolDay: now.getDay() >= 1 && now.getDay() <= 5,
                interruptions: timerState.currentInterruptions,
                hour: startDate.getHours()
            };
            
            data.logs.push(log);
            saveData(data);
            
            // UI ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('finish-modal').classList.add('hidden');
            document.getElementById('timer-display').textContent = '00:00:00';
            document.getElementById('timer-status').textContent = 'æº–å‚™å®Œäº†';
            document.getElementById('timer-status').classList.remove('text-green-600', 'text-orange-500');
            document.getElementById('btn-start').classList.remove('hidden');
            document.getElementById('btn-pause').classList.add('hidden');
            document.getElementById('btn-resume').classList.add('hidden');
            document.getElementById('btn-stop').classList.add('hidden');
            document.getElementById('current-rate').classList.add('hidden');
            
            updateTodaySummary();
            alert('ä¿å­˜ã—ã¾ã—ãŸï¼ğŸ‰');
        }

        function updateTodaySummary() {
            const data = loadData();
            const today = new Date().toISOString().split('T')[0];
            const todayLogs = data.logs.filter(l => l.date === today);
            
            const studyMin = todayLogs.reduce((sum, l) => sum + l.actualStudyMin, 0);
            const interruptMin = todayLogs.reduce((sum, l) => sum + l.interruptionMin, 0);
            
            document.getElementById('today-study').textContent = studyMin;
            document.getElementById('today-interrupt').textContent = interruptMin;
            document.getElementById('today-sessions').textContent = todayLogs.length;
        }

        // ===== ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ =====
        function switchTab(tabName) {
            // å…¨ã‚¿ãƒ–ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('tab-active');
                b.classList.add('text-gray-600');
            });
            
            // é¸æŠã‚¿ãƒ–ã‚’è¡¨ç¤º
            document.getElementById(`panel-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600');
            
            // ã‚¿ãƒ–å›ºæœ‰ã®å‡¦ç†
            if (tabName === 'stats') renderCharts();
            if (tabName === 'ai') updateAIPanel();
            if (tabName === 'settings') updateSettingsPanel();
        }

        // ===== ã‚°ãƒ©ãƒ•æç”» =====
        let charts = {};

        function renderCharts() {
            const data = loadData();
            const logs = data.logs;
            
            // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            Object.values(charts).forEach(c => c.destroy());
            charts = {};

            // ãƒ‰ãƒ¼ãƒŠãƒ„ãƒãƒ£ãƒ¼ãƒˆ
            const totalStudy = logs.reduce((s, l) => s + l.actualStudyMin, 0);
            const totalInterrupt = logs.reduce((s, l) => s + l.interruptionMin, 0);
            
            const ctx1 = document.getElementById('chart-doughnut').getContext('2d');
            charts.doughnut = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['å‹‰å¼·æ™‚é–“', 'ä¸­æ–­æ™‚é–“'],
                    datasets: [{
                        data: [totalStudy || 1, totalInterrupt],
                        backgroundColor: ['#10b981', '#f97316']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // æ™‚é–“å¸¯åˆ¥é›†ä¸­åº¦
            const hourlyData = {};
            for (let h = 6; h <= 23; h++) hourlyData[h] = { sum: 0, count: 0 };
            logs.forEach(l => {
                if (l.hour >= 6 && l.hour <= 23) {
                    hourlyData[l.hour].sum += l.concentration;
                    hourlyData[l.hour].count++;
                }
            });
            
            const ctx2 = document.getElementById('chart-hourly').getContext('2d');
            charts.hourly = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(hourlyData).map(h => h + 'æ™‚'),
                    datasets: [{
                        label: 'å¹³å‡é›†ä¸­åº¦',
                        data: Object.values(hourlyData).map(d => d.count > 0 ? (d.sum / d.count).toFixed(1) : 0),
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 5 } }
                }
            });

            // ä¸­æ–­ç†ç”±
            const reasons = {};
            logs.forEach(l => {
                l.interruptions.forEach(i => {
                    reasons[i.reason] = (reasons[i.reason] || 0) + i.count;
                });
            });
            
            const reasonLabels = {
                smartphone: 'ğŸ“±ã‚¹ãƒãƒ›', family: 'ğŸ å®¶æ—', sleepy: 'ğŸ’¤çœ æ°—',
                toilet: 'ğŸš½ãƒˆã‚¤ãƒ¬', snack: 'ğŸªãŠã‚„ã¤', other: 'â“ãã®ä»–'
            };
            
            const ctx3 = document.getElementById('chart-reasons').getContext('2d');
            charts.reasons = new Chart(ctx3, {
                type: 'pie',
                data: {
                    labels: Object.keys(reasons).map(r => reasonLabels[r] || r),
                    datasets: [{
                        data: Object.values(reasons),
                        backgroundColor: ['#3b82f6', '#ec4899', '#8b5cf6', '#10b981', '#f59e0b', '#6b7280']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // è‡ªå‹•ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
            generateAdvice(logs, hourlyData, reasons);
        }

        function generateAdvice(logs, hourlyData, reasons) {
            const adviceDiv = document.getElementById('auto-advice');
            const advices = [];

            if (logs.length === 0) {
                adviceDiv.innerHTML = '<p class="text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã‚‹ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
                return;
            }

            // ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¿ã‚¤ãƒ ã‚’è¦‹ã¤ã‘ã‚‹
            let bestHour = null, bestAvg = 0;
            Object.entries(hourlyData).forEach(([h, d]) => {
                if (d.count > 0) {
                    const avg = d.sum / d.count;
                    if (avg > bestAvg) { bestAvg = avg; bestHour = h; }
                }
            });
            if (bestHour && bestAvg >= 3) {
                advices.push(`ğŸŒŸ ã‚ãªãŸã®ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¿ã‚¤ãƒ ã¯<span class="font-bold text-indigo-600">${bestHour}æ™‚</span>ã§ã™ï¼ˆé›†ä¸­åº¦${bestAvg.toFixed(1)}ï¼‰`);
            }

            // ä¸­æ–­ç†ç”±ãƒˆãƒƒãƒ—
            const topReason = Object.entries(reasons).sort((a, b) => b[1] - a[1])[0];
            if (topReason) {
                const total = Object.values(reasons).reduce((a, b) => a + b, 0);
                const pct = Math.round((topReason[1] / total) * 100);
                const labels = { smartphone: 'ã‚¹ãƒãƒ›', family: 'å®¶æ—', sleepy: 'çœ æ°—', toilet: 'ãƒˆã‚¤ãƒ¬', snack: 'ãŠã‚„ã¤', other: 'ãã®ä»–' };
                advices.push(`âš ï¸ ä¸­æ–­åŸå› ã®<span class="font-bold text-orange-500">${pct}%</span>ã¯ã€Œ${labels[topReason[0]]}ã€ã§ã™`);
            }

            // å¹³å‡é›†ä¸­åº¦
            const avgConc = logs.reduce((s, l) => s + l.concentration, 0) / logs.length;
            if (avgConc < 3) {
                advices.push('ğŸ’ª é›†ä¸­åº¦ãŒä½ã‚ã§ã™ã€‚ä¼‘æ†©ã‚’ã—ã£ã‹ã‚Šå–ã£ã¦ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼');
            } else if (avgConc >= 4) {
                advices.push('ğŸ‰ é›†ä¸­åŠ›ãƒãƒƒãƒãƒªï¼ã“ã®èª¿å­ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ï¼');
            }

            adviceDiv.innerHTML = advices.map(a => `<p class="bg-gray-50 rounded-lg p-3">ğŸ’¡ ${a}</p>`).join('');
        }

        // ===== AIæ©Ÿèƒ½ =====
        function updateAIPanel() {
            const data = loadData();
            const hasKey = data.settings.geminiApiKey;
            
            document.getElementById('api-status').textContent = hasKey ? 'è¨­å®šæ¸ˆã¿ âœ“' : 'æœªè¨­å®š';
            document.getElementById('api-status').className = hasKey ? 'text-green-500' : 'text-red-500';
            
            // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            const recentLogs = data.logs.slice(-7);
            if (recentLogs.length > 0) {
                const summary = {
                    totalSessions: recentLogs.length,
                    totalStudyMin: recentLogs.reduce((s, l) => s + l.actualStudyMin, 0),
                    avgConcentration: (recentLogs.reduce((s, l) => s + l.concentration, 0) / recentLogs.length).toFixed(1),
                    topInterruption: getTopInterruption(recentLogs)
                };
                document.getElementById('ai-data-preview').textContent = JSON.stringify(summary, null, 2);
            }
        }

        function getTopInterruption(logs) {
            const reasons = {};
            logs.forEach(l => l.interruptions.forEach(i => {
                reasons[i.reason] = (reasons[i.reason] || 0) + i.count;
            }));
            const top = Object.entries(reasons).sort((a, b) => b[1] - a[1])[0];
            return top ? top[0] : 'ãªã—';
        }

        async function askAI() {
            const data = loadData();
            const apiKey = data.settings.geminiApiKey;
            const userInput = document.getElementById('ai-input').value;

            if (!userInput.trim()) {
                alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!apiKey) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å®šå‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹
                document.getElementById('ai-result').classList.remove('hidden');
                document.getElementById('ai-response').textContent = 
                    'ğŸ’¡ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€åŸºæœ¬ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡¨ç¤ºã—ã¾ã™ï¼š\n\n' +
                    '1. ã¾ãšã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ãƒ†ã‚¹ãƒˆã®æ—¥ã‚’ç™»éŒ²ã—ã¾ã—ã‚‡ã†\n' +
                    '2. ãƒ†ã‚¹ãƒˆ3æ—¥å‰ã‹ã‚‰å¾©ç¿’ã‚’å§‹ã‚ã‚‹ã¨åŠ¹æœçš„ã§ã™\n' +
                    '3. 1å›ã®å‹‰å¼·ã¯25åˆ†é›†ä¸­â†’5åˆ†ä¼‘æ†©ã®ãƒªã‚ºãƒ ãŒãŠã™ã™ã‚\n\n' +
                    'ï¼ˆè¨­å®šã‹ã‚‰APIã‚­ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€AIãŒå€‹åˆ¥ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä½œæˆã—ã¾ã™ï¼‰';
                return;
            }

            // Gemini APIå‘¼ã³å‡ºã—
            const btn = document.getElementById('btn-ask-ai');
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ è€ƒãˆä¸­...';

            const recentLogs = data.logs.slice(-14);
            const prompt = `ã‚ãªãŸã¯ä¸­å­¦ç”Ÿå‘ã‘ã®å­¦ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨è³ªå•ã«åŸºã¥ã„ã¦ã€å…·ä½“çš„ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¦ãã ã•ã„ã€‚

ã€éå»ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã€‘
${JSON.stringify(recentLogs, null, 2)}

ã€è³ªå•ãƒ»ç›¸è«‡ã€‘
${userInput}

ã€å›ç­”ã®ãƒ«ãƒ¼ãƒ«ã€‘
- ä¸­å­¦ç”Ÿã«ã‚ã‹ã‚Šã‚„ã™ã„è¨€è‘‰ã§
- å…·ä½“çš„ãªæ™‚é–“ã‚„æ—¥ç¨‹ã‚’ææ¡ˆ
- åŠ±ã¾ã—ã‚’å«ã‚ã‚‹
- ç®‡æ¡æ›¸ãã§æ•´ç†`;

            try {
                // ä¿®æ­£: ãƒ¢ãƒ‡ãƒ«åã‚’ 'gemini-1.5-flash-latest' ã«å¤‰æ›´ã—ã€ã‚ˆã‚Šæ˜ç¤ºçš„ã«æŒ‡å®š
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 1024
                            }
                        })
                    }
                );

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error.message);
                }

                const aiText = result.candidates[0].content.parts[0].text;
                document.getElementById('ai-result').classList.remove('hidden');
                document.getElementById('ai-response').textContent = aiText;

            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸª„ è¨ˆç”»ã‚’ä½œæˆ';
            }
        }

        function downloadICS() {
            const aiResponse = document.getElementById('ai-response').textContent;
            const now = new Date();
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            
            const formatDate = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            
            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//StudyLens Lite//JP
BEGIN:VEVENT
UID:${Date.now()}@studylens
DTSTAMP:${formatDate(now)}
DTSTART:${formatDate(tomorrow)}
DTEND:${formatDate(new Date(tomorrow.getTime() + 60 * 60 * 1000))}
SUMMARY:ğŸ“š å­¦ç¿’è¨ˆç”»ï¼ˆStudyLensï¼‰
DESCRIPTION:${aiResponse.replace(/\n/g, '\\n').substring(0, 500)}
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'study-plan.ics';
            link.click();
        }

        // ===== è¨­å®šæ©Ÿèƒ½ =====
        function updateSettingsPanel() {
            const data = loadData();
            document.getElementById('api-key-input').value = data.settings.geminiApiKey || '';
            
            // å±¥æ­´è¡¨ç¤º
            const historyDiv = document.getElementById('history-list');
            if (data.logs.length === 0) {
                historyDiv.innerHTML = '<p class="text-gray-500">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                historyDiv.innerHTML = data.logs.slice(-20).reverse().map(l => `
                    <div class="bg-gray-50 rounded-lg p-2 flex justify-between items-center">
                        <div>
                            <span class="font-medium">${l.date}</span>
                            <span class="text-gray-400">${l.startTime}-${l.endTime}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-green-600">${l.actualStudyMin}åˆ†</span>
                            <span class="text-xs text-gray-400">é›†ä¸­åº¦${l.concentration}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        function saveApiKey() {
            const key = document.getElementById('api-key-input').value.trim();
            const data = loadData();
            data.settings.geminiApiKey = key;
            saveData(data);
            alert('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            updateAIPanel();
        }

        function exportData() {
            const data = loadData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `studylens-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.logs && imported.settings) {
                        saveData(imported);
                        alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼');
                        updateTodaySummary();
                        updateSettingsPanel();
                    } else {
                        alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
                    }
                } catch (err) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                localStorage.removeItem(STORAGE_KEY);
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                location.reload();
            }
        }

        // ===== åˆæœŸåŒ– =====
        document.addEventListener('DOMContentLoaded', () => {
            updateTodaySummary();
        });
    </script>
</body>
</html>

